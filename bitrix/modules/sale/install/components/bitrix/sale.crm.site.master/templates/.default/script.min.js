BX.namespace("BX.Sale.CrmSiteMasterComponent");(function(){"use strict";BX.Sale.CrmSiteMasterComponent={init:function(t){this.wizardSteps=t.wizardSteps;this.formId=t.formId||"";this.formNode=BX(t.formId);this.documentRoot=t.documentRoot||"";this.siteName=t.siteName||"";this.docRootNode=BX(t.docRootId);this.docRootLinkNode=BX(t.docRootLinkId);this.createSiteNode=BX(t.createSiteId);this.keyNode=BX(t.keyId);this.keyButtonNode=BX(t.keyButtonId);this.keyInputBlockNode=BX(t.keyInputBlockId);this.confirmationCheckboxNode=BX(t.confirmationCheckboxId);this.nextButtonNode=document.forms[this.formId].elements[t.nextButtonId];this.prevButtonNode=document.forms[this.formId].elements[t.prevButtonId];this.cancelButtonNode=document.forms[this.formId].elements[t.cancelButtonId];this.finishButtonNode=document.forms[this.formId].elements[t.finishButtonId];this.currentStepId=t.currentStepId;this.licenseKeyRegExp=/^([A-Z0-9]{3}-[A-Z0-9]{2}-[A-Z0-9]{12,16})$/gm;if(this.currentStepId!==undefined){if(this.wizardSteps.includes(this.currentStepId)&&this.currentStepId==="Bitrix\\Wizard\\Steps\\SiteStep"){this.bindSiteEvents();var e=document.getElementsByName(this.siteName)[0];this.saleNewSiteForm(e);BX.bind(e,"change",BX.proxy(this.saleNewSiteForm.bind(this,e),this))}if(this.wizardSteps.includes(this.currentStepId)&&this.currentStepId==="Bitrix\\Wizard\\Steps\\ActivationKeyStep"){this.bindKeyEvents()}if(this.wizardSteps.includes(this.currentStepId)&&(this.currentStepId==="Bitrix\\Wizard\\Steps\\SiteInstructionStep"||this.currentStepId==="Bitrix\\Wizard\\Steps\\BackupStep")){this.bindConfirmationCheckboxEvents()}}},bindSiteEvents:function(){BX.bind(this.docRootLinkNode,"click",BX.proxy(this.setDocumentRoot,this))},bindKeyEvents:function(){BX.bind(this.keyButtonNode,"click",BX.proxy(this.applyKey,this));BX.bind(this.keyNode,"click",BX.proxy(this.inputKeyClick,this))},bindConfirmationCheckboxEvents:function(){BX.bind(this.confirmationCheckboxNode,"change",BX.proxy(this.onConfirmationCheckbox,this))},saleNewSiteForm:function(t){var e=t.value==="new";this.createSiteNode.style.display=e?"block":"none"},setDocumentRoot:function(){if(this.documentRoot.length>=0){this.docRootNode.value=this.documentRoot;BX.fireEvent(this.docRootNode,"change")}},applyKey:function(t){var e=this.keyNode.value;t.preventDefault();this.keyButtonNode.disabled=true;BX.addClass(this.keyButtonNode,"ui-btn-disabled");if(e.match(this.licenseKeyRegExp)){this.changeLicenseKey(e)}else{this.activateCoupon(e)}},changeLicenseKey:function(t){var e=this;BX.ajax.runComponentAction("bitrix:sale.crm.site.master","updateLicenseKey",{mode:"ajax",data:{key:t}}).then(function(t){e.autoSubmit()},function(t){e.keyButtonNode.disabled=false;BX.removeClass(e.keyButtonNode,"ui-btn-disabled");var i="";for(var o in t.errors){if(t.errors.hasOwnProperty(o)){i+=t.errors[o].message+"<br>"}}if(i.length>0){e.addKeyError(i)}})},activateCoupon:function(t){var e=this;CHttpRequest.Action=function(t){t=e.prepareResponse(t);if(t==="Y"){e.autoSubmit()}else{e.addKeyError(BX.message("SALE_CSM_TEMPLATE_COUPON_ERROR"));e.keyButtonNode.disabled=false;BX.removeClass(e.keyButtonNode,"ui-btn-disabled")}};CHttpRequest.Send("/bitrix/admin/update_system_act.php?query_type=coupon"+"&sessid="+BX.bitrix_sessid()+"&COUPON="+escape(t)+"&updRand="+Math.random())},inputKeyClick:function(){this.removeKeyError()},prepareResponse:function(t){t=t.replace(/^\s+|\s+$/,"");while(t.length>0&&t.charCodeAt(0)==65279)t=t.substring(1);return t},autoSubmit:function(){if(this.nextButtonNode){this.formNode.submit()}},addKeyError:function(t){var e=BX(this.keyInputBlockNode.querySelector(".ui-ctl.ui-ctl-textbox"));if(BX.hasClass(e,"ui-ctl-active")){BX.removeClass(e,"ui-ctl-active");BX.addClass(e,"ui-ctl-danger");e.insertAdjacentHTML("afterend",'<div class="adm-site-master-errors">'+t+"</div>")}},removeKeyError:function(){var t=BX(this.keyInputBlockNode.querySelector(".ui-ctl.ui-ctl-textbox"));if(BX.hasClass(t,"ui-ctl-danger")){BX.removeClass(t,"ui-ctl-danger");BX.addClass(t,"ui-ctl-active");var e=BX(this.keyInputBlockNode.querySelector(".adm-site-master-errors"));if(e!==undefined){BX.remove(e)}}},onConfirmationCheckbox:function(t){if(!this.nextButtonNode)return;if(t.target.checked){this.nextButtonNode.disabled=false;BX.removeClass(this.nextButtonNode,"ui-btn-disabled")}else{this.nextButtonNode.disabled=true;BX.addClass(this.nextButtonNode,"ui-btn-disabled")}}}})();
//# sourceMappingURL=script.map.js